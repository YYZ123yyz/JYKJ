package yyz_exploit.activity.activity;

import android.annotation.SuppressLint;
import android.content.Intent;
import android.os.Handler;
import android.os.Message;
import android.support.annotation.NonNull;
import android.support.v7.app.AppCompatActivity;
import android.os.Bundle;
import android.support.v7.widget.LinearLayoutManager;
import android.support.v7.widget.OrientationHelper;
import android.support.v7.widget.RecyclerView;
import android.text.TextUtils;
import android.util.Log;
import android.view.View;
import android.webkit.WebView;
import android.widget.ImageView;
import android.widget.LinearLayout;
import android.widget.TextView;
import android.widget.Toast;

import com.alibaba.fastjson.JSON;
import com.google.gson.Gson;
import com.jcodecraeer.xrecyclerview.XRecyclerView;
import com.scwang.smartrefresh.layout.SmartRefreshLayout;
import com.scwang.smartrefresh.layout.api.RefreshLayout;
import com.scwang.smartrefresh.layout.listener.OnLoadMoreListener;
import com.scwang.smartrefresh.layout.listener.OnRefreshListener;
import com.squareup.okhttp.Callback;
import com.squareup.okhttp.Request;
import com.squareup.okhttp.Response;

import org.json.JSONArray;
import org.json.JSONObject;

import java.io.IOException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;

import netService.HttpNetService;
import netService.entity.NetRetEntity;
import www.jykj.com.jykj_zxyl.R;
import www.jykj.com.jykj_zxyl.activity.myself.SettingActivity;
import www.jykj.com.jykj_zxyl.activity.myself.setting.AboutActivity;
import www.jykj.com.jykj_zxyl.application.Constant;
import www.jykj.com.jykj_zxyl.application.JYKJApplication;
import www.jykj.com.jykj_zxyl.custom.MoreFeaturesPopupWindow;
import www.jykj.com.jykj_zxyl.util.ActivityUtil;
import yyz_exploit.activity.adapter.HelpAdapter;
import yyz_exploit.bean.HelpBean;


import static android.widget.Toast.LENGTH_SHORT;

/*
 * 帮助与反馈
 *
 * */
public class HelpActivity extends AppCompatActivity implements  View.OnClickListener{


    private TextView layout_name;
     private RecyclerView help_recy;

    private HelpAdapter helpAdapter;
    private List<HelpBean> Helplist = new ArrayList<>();
    private HelpBean helpBean;
    private JYKJApplication mApp;
    private Handler handler= new  Handler();
    private ImageView iv_add;
    private MoreFeaturesPopupWindow mPopupWindow;
    private String mNetLoginRetStr;
    private Handler mHandler;
    private LinearLayoutManager layoutManager;
    private WebView help_webview;
    private LinearLayout lin_feedback;
    private SmartRefreshLayout refreshLayout;
    private int page=0;
    private LinearLayout customer;
    private LinearLayout ll_back;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_help);
        mApp = (JYKJApplication) HelpActivity.this.getApplication();
        ActivityUtil.setStatusBarMain(HelpActivity.this);
        initView();
        layoutManager = new LinearLayoutManager(HelpActivity.this);
        layoutManager.setOrientation(LinearLayout.VERTICAL);
        help_recy.setLayoutManager(layoutManager);
        data();
        initHandler();

    }

    private void data() {
        HashMap<String, String> map = new HashMap<>();
        map.put("rowNum", "10");
        map.put("pageNum", "1");
        map.put("loginDoctorPosition", "108.93425^34.23053");
        map.put("operDoctorCode", mApp.mViewSysUserDoctorInfoAndHospital.getDoctorCode());
        map.put("operDoctorName", mApp.mViewSysUserDoctorInfoAndHospital.getUserName());

        new Thread() {
            public void run() {
                try {
                    mNetLoginRetStr = HttpNetService.urlConnectionService("jsonDataInfo=" + new Gson().toJson(map), Constant.SERVICEURL + "doctorPersonalSetControlle/searchBasicsSystemHelpResList");

                } catch (Exception e) {
                    NetRetEntity retEntity = new NetRetEntity();
                    retEntity.setResCode(0);
                    retEntity.setResMsg("网络连接异常，请联系管理员：" + e.getMessage());
                    mNetLoginRetStr = new Gson().toJson(retEntity);
                    e.printStackTrace();

                }

                mHandler.sendEmptyMessage(1);
            }
        }.start();

    }

    @SuppressLint("WrongViewCast")
    private void initView() {
        ll_back = findViewById(R.id.ll_back);
        //联系客服
        customer = findViewById(R.id.Customer);
        customer.setOnClickListener(this);
        help_recy = findViewById(R.id.help_recy);

      //快应用
        iv_add = findViewById(R.id.iv_add);
        iv_add.setVisibility(View.INVISIBLE);
        iv_add.setOnClickListener(this);

        help_webview = findViewById(R.id.help_webview);

        lin_feedback = findViewById(R.id.lin_feedback);
        lin_feedback.setOnClickListener(this);

        refreshLayout = findViewById(R.id.refreshLayout);

    }

    @Override
    public void onClick(View v) {
         switch (v.getId()){
             case R.id.Customer:
                 startActivity(new Intent(HelpActivity.this, AboutActivity.class));
                 break;
             case  R.id.ll_back:
                 finish();
                 break;
             case R.id.iv_add:
                 mPopupWindow = new MoreFeaturesPopupWindow(HelpActivity.this);
                 mPopupWindow.setHelpActivity(HelpActivity.this);
                 if (mPopupWindow != null && !mPopupWindow.isShowing()) {
                     mPopupWindow.showAsDropDown(iv_add, 0, 0);
                 }else
                     mPopupWindow.dismiss();
                 break;
             case R.id.lin_feedback :
                 Intent intent = new Intent(HelpActivity.this, FeedbackActivity.class);
                 startActivity(intent);
                 break;
         }
    }

    @SuppressLint("HandlerLeak")
    private void initHandler() {
        mHandler = new Handler() {
            @SuppressLint("HandlerLeak")
            @Override
            public void handleMessage(Message msg) {
                switch (msg.what) {
                    case 1:
                        if (mNetLoginRetStr != null && !mNetLoginRetStr.equals("")) {
                            Helplist = JSON.parseArray(JSON.parseObject(mNetLoginRetStr,NetRetEntity.class).getResJsonData(),HelpBean.class);

                                helpAdapter=new HelpAdapter(Helplist);
                                help_recy.setAdapter(helpAdapter);

                            //加载更多
                            refreshLayout.setOnLoadMoreListener(new OnLoadMoreListener() {
                                @Override
                                public void onLoadMore(@NonNull RefreshLayout refreshLayout) {
                                    page ++ ;
                                    data();
                                    helpAdapter.notifyDataSetChanged();
                                    refreshLayout.finishLoadMore(true);//加载完成
                                }
                            });
                            //刷新
                            refreshLayout.setOnRefreshListener(new OnRefreshListener() {
                                @Override
                                public void onRefresh(@NonNull RefreshLayout refreshLayout) {
                                    Helplist.clear();
                                    data();
                                    helpAdapter.notifyDataSetChanged();
                                    refreshLayout.finishRefresh(true);//刷新完成
                                }
                            });
                                helpAdapter.setOnClickListener(new HelpAdapter.onClickListener() {
                                  @Override
                                  public void onClick(View view, int position) {
                                   //   if(TextUtils.isEmpty(Helplist.get(position).getHelpContentUrl())){
//                                          String helpContentUrl = Helplist.get(position).getHelpContentUrl();
//                                          help_webview.loadUrl(helpContentUrl);//加载网址到视图
//                                          int helpId = Helplist.get(position).getHelpId();
//                                          Intent intent = new Intent(HelpActivity.this,DetailsActivity.class);
//                                          intent.putExtra("helpId",helpId);
//                                          startActivity(intent);
                                          String helpContentUrl = Helplist.get(position).getHelpContentUrl();
                                          Intent intent = new Intent(HelpActivity.this,HelpDetailsActivity.class);
                                          intent.putExtra("helpContentUrl",helpContentUrl);
                                          startActivity(intent);
                                      Log.e("tag", "onClick: 2222"+"跳转" );
                                  //    }


                                  }
                              });
                            }

                        break;
                }
            }
        };
    }
}
